<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Echo Dungeon</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background-color: #000;
            color: #fff;
            font-family: Arial, sans-serif;
            text-align: center;
        }
        
        #startButton {
            width: 300px;
            height: 100px;
            background-color: #ff4444;
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            border-radius: 10px;
            margin: 50px auto;
            display: block;
        }
        
        #gameText {
            background-color: #222;
            padding: 20px;
            margin: 20px auto;
            border-radius: 10px;
            max-width: 600px;
            min-height: 200px;
        }
    </style>
</head>
<body>
    <h1>Echo Dungeon</h1>
    
    <button id="startButton" onclick="startGame()">
        CLICK TO START VOICE GAME
    </button>
    
    <div id="gameText">
        <p>Click the red button above to begin your voice-controlled adventure!</p>
        <p>Make sure to allow microphone access when prompted.</p>
    </div>

    <script>
        let synth = window.speechSynthesis;
        let recognition = null;
        let gameStarted = false;
        let isListening = false;
        
        let player = {
            health: 100,
            class: null,
            location: 'entrance',
            inventory: []
        };
        
        let rooms = {
            entrance: {
                description: "You stand at the entrance of a dark dungeon. You can go north or east.",
                exits: { north: 'corridor', east: 'chamber' },
                items: ['torch'],
                monsters: []
            },
            corridor: {
                description: "A stone corridor. You can go south to entrance or north to treasury.",
                exits: { south: 'entrance', north: 'treasury' },
                items: ['health potion'],
                monsters: ['goblin']
            },
            chamber: {
                description: "A round chamber. You can go west to entrance or north to boss room.",
                exits: { west: 'entrance', north: 'boss_room' },
                items: ['sword'],
                monsters: ['skeleton']
            },
            treasury: {
                description: "A treasure room full of gold. You can go south to corridor.",
                exits: { south: 'corridor' },
                items: ['treasure'],
                monsters: ['guardian']
            },
            boss_room: {
                description: "The final room with a throne. You can go south to chamber.",
                exits: { south: 'chamber' },
                items: ['crown'],
                monsters: ['boss']
            }
        };
        
        let currentRoom = 'entrance';

        /**
         * Speaks a given text and handles restarting the listener.
         * @param {string} text The text to be spoken.
         * @param {function} [callback] A function to call after the speech is finished.
         */
        function speak(text, callback) {
            console.log('Speaking:', text);
            document.getElementById('gameText').innerHTML += '<p>' + text + '</p>';
            
            if (synth) {
                synth.cancel();
                let utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = 0.9;
                utterance.pitch = 1.0;
                utterance.volume = 1.0;
                
                utterance.onend = () => {
                    // Call the callback function after the speech is done.
                    // This is where we'll handle restarting the listener.
                    if (callback) {
                        setTimeout(callback, 300); // Small delay to avoid issues
                    }
                };
                utterance.onerror = () => {
                    if (callback) {
                        callback();
                    }
                };
                
                synth.speak(utterance);
            } else {
                if (callback) {
                    callback();
                }
            }
        }

        function startGame() {
            document.getElementById('startButton').style.display = 'none';
            
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                speak("Sorry, voice recognition is not supported. Please use Chrome or Edge browser.");
                return;
            }

            let SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'en-US';

            recognition.onstart = function() {
                isListening = true;
                console.log('Listening started');
            };

            recognition.onresult = function(event) {
                isListening = false;
                let command = event.results[0][0].transcript.toLowerCase();
                console.log('Command heard:', command);
                processCommand(command);
            };

            recognition.onerror = function(event) {
                isListening = false;
                console.log('Speech error:', event.error);
                if (event.error === 'not-allowed') {
                    speak("Please allow microphone access and try again.");
                } else if (event.error === 'no-speech') {
                    speak("I didn't hear anything. Let me listen again.", startListening);
                } else {
                    speak("I didn't hear you clearly. Let me listen again.", startListening);
                }
            };

            recognition.onend = function() {
                isListening = false;
                // The restart logic is now handled by the speak() function via callbacks.
            };

            speak("Welcome to Echo Dungeon! Choose your class by saying: warrior, mage, or rogue.", () => {
                // This callback ensures we only start listening after the welcome message is finished.
                startListening();
            });
        }

        function startListening() {
            if (recognition && !isListening) {
                try {
                    recognition.start();
                } catch (e) {
                    console.log('Recognition start error:', e);
                }
            }
        }

        async function processCommand(command) {
            if (!gameStarted) {
                if (command.includes('warrior')) {
                    player.class = 'warrior';
                    gameStarted = true;
                    await speak("You are now a warrior! Your adventure begins.");
                    await describeLocation();
                } else if (command.includes('mage') || command.includes('wizard')) {
                    player.class = 'mage';
                    gameStarted = true;
                    await speak("You are now a mage! Your adventure begins.");
                    await describeLocation();
                } else if (command.includes('rogue') || command.includes('thief')) {
                    player.class = 'rogue';
                    gameStarted = true;
                    await speak("You are now a rogue! Your adventure begins.");
                    await describeLocation();
                } else {
                    await speak("Please say warrior, mage, or rogue to choose your class.");
                }
                return;
            }

            // Movement
            if (command.includes('north') || command.includes('go north')) {
                await movePlayer('north');
            } else if (command.includes('south') || command.includes('go south')) {
                await movePlayer('south');
            } else if (command.includes('east') || command.includes('go east')) {
                await movePlayer('east');
            } else if (command.includes('west') || command.includes('go west')) {
                await movePlayer('west');
            }
            // Combat
            else if (command.includes('attack') || command.includes('fight')) {
                await fight();
            }
            // Search
            else if (command.includes('search') || command.includes('look')) {
                await search();
            }
            // Inventory
            else if (command.includes('inventory') || command.includes('items')) {
                await showInventory();
            }
            // Use items
            else if (command.includes('use potion') || command.includes('drink potion')) {
                await usePotion();
            }
            // Status
            else if (command.includes('status') || command.includes('health')) {
                await speak(`Your health is ${player.health}. You are a ${player.class}.`, startListening);
            }
            // Location
            else if (command.includes('where') || command.includes('location')) {
                await describeLocation();
            }
            // Help
            else if (command.includes('help')) {
                await speak("Say: north, south, east, west to move. Say attack to fight. Say search to look for items. Say inventory to check items. Say status for health.", startListening);
            }
            else {
                await speak("I don't understand. Say help for commands.", startListening);
            }
        }

        async function movePlayer(direction) {
            let room = rooms[currentRoom];
            if (room.exits[direction]) {
                currentRoom = room.exits[direction];
                player.location = currentRoom;
                await speak(`You go ${direction}.`);
                await describeLocation();
            } else {
                await speak(`You cannot go ${direction} from here.`, startListening);
            }
        }

        async function describeLocation() {
            let room = rooms[currentRoom];
            let description = room.description;
            
            if (room.monsters.length > 0) {
                description += ` A ${room.monsters[0]} is here!`;
            }
            
            if (room.items.length > 0) {
                description += ` You see: ${room.items.join(', ')}.`;
            }
            
            await speak(description, startListening);
        }

        async function fight() {
            let room = rooms[currentRoom];
            if (room.monsters.length === 0) {
                await speak("Nothing to fight here.", startListening);
                return;
            }
            
            let monster = room.monsters[0];
            let playerRoll = Math.floor(Math.random() * 20) + 1;
            let monsterRoll = Math.floor(Math.random() * 20) + 1;
            
            if (playerRoll >= monsterRoll) {
                await speak(`You defeat the ${monster}!`, startListening);
                room.monsters = [];
            } else {
                await speak(`The ${monster} hits you! You lose health.`, startListening);
                player.health -= 20;
                if (player.health <= 0) {
                    await speak("You died! Game over. Say warrior, mage, or rogue to restart.", startListening);
                    gameStarted = false;
                    player.health = 100;
                    currentRoom = 'entrance';
                }
            }
        }

        async function search() {
            let room = rooms[currentRoom];
            if (room.items.length > 0) {
                let item = room.items.shift();
                player.inventory.push(item);
                await speak(`You found a ${item}!`, startListening);
            } else {
                await speak("You found nothing.", startListening);
            }
        }

        async function showInventory() {
            if (player.inventory.length === 0) {
                await speak("Your inventory is empty.", startListening);
            } else {
                await speak(`You have: ${player.inventory.join(', ')}.`, startListening);
            }
        }

        async function usePotion() {
            let potionIndex = player.inventory.indexOf('health potion');
            if (potionIndex !== -1) {
                player.inventory.splice(potionIndex, 1);
                player.health = Math.min(100, player.health + 50);
                await speak(`You drink the potion. Health restored to ${player.health}.`, startListening);
            } else {
                await speak("You don't have a health potion.", startListening);
            }
        }
    </script>
</body>
</html>


